name: ada chatgpt workflow

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14
    - name: Set the Node.js environment variable
      run: echo "NODE_ENV=production" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    - name: Install dependencies
      run: npm install
    - name: Install pa11y-ci globally
      run: npm install -g pa11y-ci

    - name: Run ADA compliance checks and save the report
      run: pa11y-ci > ada-report.txt

    - name: Send ADA report to ChatGPT
      run: |
        $report = Get-Content -Path ada-report.txt -Raw
        $payload = @{
          "prompt" = "ADA report:`n`n$report"
          "max_tokens" = 5
          "n" = 1
          "stop" = $null
          "temperature" = 0.7
        } | ConvertTo-Json
        $headers = @{
          "Content-Type" = "application/json"
          "Authorization" = "Bearer ${{ secrets.CHATGPT_API }}"
        }
        Invoke-RestMethod -Uri "https://api.openai.com/v1/engines/text-davinci-002/completions" -Method POST -Headers $headers -Body $payload
      shell: pwsh
